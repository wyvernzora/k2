#cloud-config
hostname: 'k2-{{ "{{ trunc 4 .MachineID }}" }}'

bundles:
  - targets:
      - run://ghcr.io/wyvernzora/k2-crds:latest

users:
  - name: kairos
    passwd: '{{ op://K2/wyvernzora/passwd }}'
    ssh_authorized_keys:
      - github:wyvernzora

growpart:
    devices: ['/']

k3s:
    enabled: true
    args:
      - '--cluster-init'                      # Spin up k3s in cluster mode
      - '--tls-san=10.10.8.2'                 # Make sure k8s control-plane cert has KubeVIP IP
      - '--disable=traefik,servicelb'         # We'll be deploying our own Traefik and MetalLB
      - '--secrets-encryption'                # Encrypt secrets at rest
      - '--flannel-backend=wireguard-native'  # Use WireGuard for intra-cluster network

kubevip:
    enabled: true
    eip: 10.10.8.2

onepassword:
    credentials: "{{ op://K2/1Password Connect/credential }}"
    token: "{{ op://K2/1Password Connect/token }}"

argocd: { }
