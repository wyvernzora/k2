apiVersion: v1
kind: Secret
metadata:
  labels:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authelia
    app.kubernetes.io/version: 4.38.16
    helm.sh/chart: authelia-0.9.9
  name: authelia
  namespace: k2-auth
data:
  authentication.ldap.password.txt: YWVYTmZaYTFGenpyaW1DejhoeUhOUHJpM20ycU54TkNNR0ZQSVpNdnRIazd2QkNzTGZ2WnVUaU9jSlc4Y1FtWkoyN2pmNmZ1czBkaHJmMWI4OTByS0dTOGlPQU1xTjg0eERVSVJ4NW1sbW1tQTlXdm9sSTFzS3VyZzdmYldRcjQ=
  identity_validation.reset_password.jwt.hmac.key: MklvYmZmek9ManptNkxiTFdvNTBEWWEwTUUyeW5lTldQZmk5NWp6Q0NPWGdqQTRZaEcyREFYRWMzbDY3NXU3VGpLdko0MXh1b0JKRTVjVEE5MDJ5MG1Jc2tIRDF5QnpiZ1l5Q1NTMWpja1c3bE9ndmFERXZMaG5vYzVORFNQRlc=
  session.encryption.key: YzV4Zm05bG91cTFMZUc3NktjRVhhT0xWYkRBY2pLOHR6QVZqQTVqOExQRUFWRFpZQ1lXWHdBSDNMM1J6QzZDSkhDdGtHUkVmWmZiYzhzbTBmdTFjM1d0eGlBdjQybHBEVzA5dlhJdTF4ajRON2pzYUVBVHY1cFRwQmMzTnUyWUg=
  storage.encryption.key: QmRtUkEwSm5WZEFKNlZDRlNMQm5FVzVDZjdFSFBpSk55OHh3OU8wNzFLQWgxeGk2VW1aOXR5Z1lkY2M2azgzSzJyakVPbm5TYUVjQVdHQ0pNNDFEQUNKNUtmck14YnhXZ0dzemVUakpmUHpFSlE4QXE1MTdicnBzb1k0TmE2eFI=
type: Opaque
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authelia
    app.kubernetes.io/version: 4.38.16
    helm.sh/chart: authelia-0.9.9
  name: authelia
  namespace: k2-auth
data:
  configuration.yaml: |
    ---
    # yaml-language-server: $schema=https://www.authelia.com/schemas/v4.38/json-schema/configuration.json
    theme: 'light'
    default_2fa_method: ''
    server:
      address: 'tcp://0.0.0.0:9091/'
      asset_path: ''
      headers:
        csp_template: ''
      buffers:
        read: 4096
        write: 4096
      timeouts:
        read: '6 seconds'
        write: '6 seconds'
        idle: '30 seconds'
      endpoints:
        enable_pprof: false
        enable_expvars: false
        authz:
          auth-request:
            implementation: 'AuthRequest'
          ext-authz:
            implementation: 'ExtAuthz'
          forward-auth:
            implementation: 'ForwardAuth'
    log:
      level: 'info'
      format: 'text'
      file_path: ''
      keep_stdout: true
    telemetry:
      metrics:
        enabled: false
    identity_validation:
      elevated_session:
        code_lifespan: '5 minutes'
        elevation_lifespan: '10 minutes'
        characters: 8
        require_second_factor: false
        skip_second_factor: false
      reset_password:
        jwt_lifespan: '5 minutes'
        jwt_algorithm: 'HS256'
    totp:
      disable: false
      issuer: 'Authelia'
      skew: 1
      secret_size: 32
      algorithm: 'SHA1'
      digits: 6
      period: 30
      allowed_algorithms:
        - 'SHA1'
      allowed_digits:
        - 6
      allowed_periods:
        - 30
    webauthn:
      disable: false
      display_name: 'Authelia'
      attestation_conveyance_preference: 'indirect'
      user_verification: 'preferred'
      timeout: '60 seconds'
    ntp:
      address: 'udp://time.cloudflare.com:123'
      version: 4
      max_desync: '3 seconds'
      disable_startup_check: false
      disable_failure: false
    authentication_backend:
      password_reset:
        disable: false
        custom_url: ''
      ldap:
        implementation: 'custom'
        address: 'ldap://openldap.default.svc.cluster.local'
        timeout: '5 seconds'
        start_tls: false
        tls:
          server_name: 'ldap.wyvernzora.io'
          skip_verify: false
          minimum_version: 'TLS1.2'
          maximum_version: 'TLS1.3'
        base_dn: 'dc=wyvernzora,dc=io'
        additional_users_dn: 'ou=users'
        users_filter: '(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=posixAccount))'
        additional_groups_dn: 'ou=groups'
        groups_filter: '(&(memberUid={username})(objectClass=posixGroup))'
        permit_referrals: false
        permit_unauthenticated_bind: false
        permit_feature_detection_failure: false
        user: 'cn=authelia,dc=wyvernzora,dc=io'
        attributes:
          distinguished_name: ''
          username: ''
          display_name: ''
          mail:  ''
          member_of:  ''
          group_name:  ''
    password_policy:
      standard:
        enabled: false
        min_length: 8
        max_length: 0
        require_uppercase: false
        require_lowercase: false
        require_number: false
        require_special: false
      zxcvbn:
        enabled: false
        min_score: 0
    session:
      name: 'authelia_session'
      same_site: 'lax'
      inactivity: '5 minutes'
      expiration: '1 hour'
      remember_me: '1 month'
      cookies:
        - domain: 'wyvernzora.io'
          authelia_url: 'https://auth.wyvernzora.io'
          default_redirection_url: 'https://h.wyvernzora.io'
    regulation:
      max_retries: 3
      find_time: '2 minutes'
      ban_time: '5 minutes'
    storage:
      local:
        path: '/var/authelia/db.sqlite3'
    notifier:
      disable_startup_check: false
      filesystem:
        filename: '/var/authelia/notifications.log'
    access_control:
      default_policy: 'one_factor'
      networks:
        - name: private
          networks:
            - '10.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
    ...
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authelia
    app.kubernetes.io/version: 4.38.16
    helm.sh/chart: authelia-0.9.9
  name: authelia
  namespace: k2-auth
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: http
  selector:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/name: authelia
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authelia
    app.kubernetes.io/version: 4.38.16
    helm.sh/chart: authelia-0.9.9
  name: authelia
  namespace: k2-auth
spec:
  minReadySeconds: 0
  replicas: 1
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app.kubernetes.io/instance: authelia
      app.kubernetes.io/name: authelia
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      annotations:
        authelia.com/checksum-config: 771b621c71908aaf6bd1c38a91a42c94015bd3b11546e1fa328e1176e14c267f
        authelia.com/checksum-secret: d494306e368baeef255f75969c6564561d5531ec73b030aa263198ce92b5e622
      labels:
        app.kubernetes.io/instance: authelia
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: authelia
        app.kubernetes.io/version: 4.38.16
        helm.sh/chart: authelia-0.9.9
    spec:
      affinity:
        nodeAffinity: {}
        podAffinity: {}
        podAntiAffinity: {}
      containers:
        - command:
            - authelia
          env:
            - name: AUTHELIA_SERVER_DISABLE_HEALTHCHECK
              value: "true"
            - name: AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE
              value: /secrets/internal/identity_validation.reset_password.jwt.hmac.key
            - name: AUTHELIA_SESSION_SECRET_FILE
              value: /secrets/internal/session.encryption.key
            - name: AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD_FILE
              value: /secrets/internal/authentication.ldap.password.txt
            - name: AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE
              value: /secrets/internal/storage.encryption.key
            - name: X_AUTHELIA_CONFIG
              value: /configuration.yaml
            - name: X_AUTHELIA_CONFIG_FILTERS
              value: template
          image: ghcr.io/authelia/authelia:4.38.16
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 5
            httpGet:
              path: /api/health
              port: http
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 5
          name: authelia
          ports:
            - containerPort: 9091
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 5
            httpGet:
              path: /api/health
              port: http
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 5
          resources:
            limits: {}
            requests: {}
          startupProbe:
            failureThreshold: 6
            httpGet:
              path: /api/health
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 5
          volumeMounts:
            - mountPath: /configuration.yaml
              name: config
              readOnly: true
              subPath: configuration.yaml
            - mountPath: /secrets/internal
              name: secrets
              readOnly: true
            - mountPath: /var/authelia
              name: ephemeral
      enableServiceLinks: false
      hostIPC: false
      hostNetwork: false
      hostPID: false
      volumes:
        - configMap:
            items:
              - key: configuration.yaml
                path: configuration.yaml
            name: authelia
          name: config
        - name: secrets
          secret:
            items:
              - key: identity_validation.reset_password.jwt.hmac.key
                path: identity_validation.reset_password.jwt.hmac.key
              - key: session.encryption.key
                path: session.encryption.key
              - key: authentication.ldap.password.txt
                path: authentication.ldap.password.txt
              - key: storage.encryption.key
                path: storage.encryption.key
            secretName: authelia
        - emptyDir: {}
          name: ephemeral
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  labels:
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: authelia
    app.kubernetes.io/version: 4.38.16
    helm.sh/chart: authelia-0.9.9
  name: authelia
  namespace: k2-auth
spec:
  rules:
    - host: auth.wyvernzora.io
      http:
        paths:
          - backend:
              service:
                name: authelia
                port:
                  number: 80
            path: /
            pathType: Prefix
  tls:
    - hosts:
        - auth.wyvernzora.io
      secretName: default-certificate
---
apiVersion: onepassword.com/v1
kind: OnePasswordItem
metadata:
  name: authelia
  namespace: k2-auth
spec:
  itemPath: vaults/zfsyjjcwge4w4gw6dh4zaqndhq/items/ejfcz3g4s6wsr2jtct6hs3alxi
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authelia
  namespace: k2-auth
spec:
  forwardAuth:
    address: http://authelia.k2-auth.svc.cluster.local/api/verify?rd=https%3A%2F%2Fauth.wyvernzora.io%2F
    authResponseHeaders:
      - Remote-User
      - Remote-Groups
      - Remote-Email
      - Remote-Name
