#cloud-config
hostname: 'k2-{{ "{{ trunc 4 .MachineID }}" }}'

bundles:
  - targets:
      - run://ghcr.io/wyvernzora/k2-kairos-bundle:crds
      - run://ghcr.io/wyvernzora/k2-kairos-bundle:kube-vip
      - run://ghcr.io/wyvernzora/k2-kairos-bundle:1password-connect
      - run://ghcr.io/wyvernzora/k2-kairos-bundle:argocd
      # - run://ghcr.io/wyvernzora/k2-kairos-bundle:cert-manager
      # - run://ghcr.io/wyvernzora/k2-kairos-bundle:traefik

users:
  - name: kairos
    passwd: '{{ op://K2/wyvernzora/passwd }}'
    ssh_authorized_keys:
      - github:wyvernzora

growpart:
    devices: ['/']

k3s:
    enabled: true
    args:
        # Spin up k3s in cluster mode
      - '--cluster-init'
      - '--token={{ op://K2/k2.wyvernzora.io/server-token }}'

        # Make sure k8s control-plane cert has KubeVIP IP
      - '--tls-san=10.10.8.2'

        # We'll be deploying our own Traefik and MetalLB
      - '--disable=traefik,servicelb'

        # Encrypt secrets at rest
      - '--secrets-encryption'

        # Use WireGuard for intra-cluster network
      - '--flannel-backend=wireguard-native'

kubevip:
    enabled: true
    eip: 10.10.8.2
    interface: ens18

onepassword:
    credentials: "{{ op://K2/1Password Connect/credential }}"
    token: "{{ op://K2/1Password Connect/token }}"

argocd: { }

cert_manager: { }

traefik: { }
